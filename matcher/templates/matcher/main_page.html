{% extends 'matcher/base.html' %}
{% load matcher_extras %}
{% load static %}

{% block title %}JobbAI - Your AI Job Copilot{% endblock %}

{% block content %}
<div class="jobbAI-main-container container-fluid p-0">
    <!-- Top Navigation Bar (New) -->
    <!-- <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top jobbAI-top-nav">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">
                {# Placeholder for logo - will add actual SVG or image later #}
                <img src="{% static 'matcher/images/logo.svg' %}" alt="JobbAI Logo" style="height: 24px;"> {# TODO: Replace with actual logo asset #}
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNavbarNav" aria-controls="topNavbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="topNavbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{% url 'matcher:main_page' %}">Matches</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Applications</a> {# TODO: Link to applications page #}
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Profile</a> {# TODO: Link to profile page #}
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    {# Placeholder for User Profile Icon/Dropdown #}
                    <i class="fas fa-user-circle fa-lg"></i>
                </div>
            </div>
        </div>
    </nav> -->

    <div class="container-fluid jobbAI-content-wrapper">
        <div class="row g-0">
            <!-- Sidebar: Match History & New Match Button -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-4 d-md-block bg-white border-end jobbAI-sidebar">
                <div class="position-sticky pt-3 sidebar-sticky">
                    <div class="px-3 mb-3">
                <a href="{% url 'matcher:main_page' %}" 
                           class="btn btn-primary w-100 {% if not current_match_session_id %}active{% endif %}">
                            <i class="fas fa-plus-circle me-2"></i>Start New Match
                        </a>
                    </div>
                    
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Today's Matches</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        {% for session in match_history %}
                            {% if session.matched_at|date:"Y-m-d" == today_date_str %} {# Assuming today_date_str is passed to context #}
                            <li class="nav-item">
                                <a class="nav-link {% if session.id|stringformat:"s" == current_match_session_id %}active fw-bold{% endif %}" 
                                   href="{% url 'matcher:main_page' %}?session_id={{ session.id }}">
                                    <i class="fas fa-calendar-day me-2"></i>
                                    <span class="sidebar-text">{{ session.matched_at|date:"H:i" }} - {{ session.skills_text|truncatewords:3 }}</span>
                                </a>
                            </li>
                            {% endif %}
                        {% empty %}
                            <li class="nav-item px-3">
                                <small class="text-muted sidebar-text">No matches today.</small>
                            </li>
                        {% endfor %}
                    </ul>

                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>History Matches</span>
                    </h6>
                <ul class="nav flex-column">
                    {% for session in match_history %}
                             {% if session.matched_at|date:"Y-m-d" != today_date_str %}
                        <li class="nav-item">
                            <a class="nav-link {% if session.id|stringformat:"s" == current_match_session_id %}active fw-bold{% endif %}" 
                               href="{% url 'matcher:main_page' %}?session_id={{ session.id }}">
                                <i class="fas fa-history me-2"></i>
                                    <span class="sidebar-text">{{ session.matched_at|date:"Y-m-d" }} - {{ session.skills_text|truncatewords:3 }}</span>
                            </a>
                        </li>
                            {% endif %}
                    {% empty %}
                            <li class="nav-item px-3">
                                <small class="text-muted sidebar-text">No past match history.</small>
                            </li>
                        {% endfor %}
                         {% if not match_history %} {# Handle case where match_history itself is empty #}
                        <li class="nav-item px-3">
                            <small class="text-muted sidebar-text">No match history yet.</small>
                        </li>
                        {% endif %}
                </ul>
                </div>
            </nav>

        <!-- Main content -->
            <main class="px-md-4 main-content-area jobbAI-main-content">
                {# Desktop Sidebar Toggle - to be handled by JS, removed from here as it's part of overall page structure not dynamic content #}
                <!-- <button id="sidebarToggleDesktop" class="btn btn-link d-none d-md-inline-block me-3" type="button" title="Toggle sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>  -->

                <!-- Header section for stats and CV/Preference update -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        {% if processed_job_matches %}
                            {{ processed_job_matches|length }} Best Matches, {{ all_jobs_count }} Job Listings
                        {% else %}
                            {{ all_jobs_count }} Job Listings
                        {% endif %}
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#cvModal">Update CV/Resume</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#preferencesModal">Edit Preferences</button>
                        </div>
                </div>
            </div>

                <!-- CV and Preferences Input Modals (Moved from direct form) -->
                <!-- CV Modal -->
                <div class="modal fade" id="cvModal" tabindex="-1" aria-labelledby="cvModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <form method="POST" action="{% url 'matcher:main_page' %}" id="cvForm">
                        {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="cvModalLabel">Update CV/Resume</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">

                                    {% if parsed_data %}
                                        <div class="card mb-3">
                                            <div class="card-header"><h5>Extracted Information</h5></div>
                                            <div class="card-body">
                                                {% if parsed_data.name %}<p><strong>Name:</strong> {{ parsed_data.name }}</p>{% endif %}
                                                {% if parsed_data.email %}<p><strong>Email:</strong> {{ parsed_data.email }}</p>{% endif %}
                                                {% if parsed_data.contact_number %}<p><strong>Contact Number:</strong> {{ parsed_data.contact_number }}</p>{% endif %}
                                                {% if parsed_data.skills %}<p><strong>Skills:</strong> {{ parsed_data.skills|join:', ' }}</p>{% endif %}
                                                {% if parsed_data.education %}<p><strong>Education:</strong> {{ parsed_data.education|join:', ' }}</p>{% endif %}
                                            </div>
                                        </div>
                                    {% endif %}

                        <div class="form-group mb-3">
                                        <label for="user_cv_text_modal" class="form-label"><strong>CV / Resume / Key Skills:</strong></label>
                                        <textarea name="user_cv_text" id="user_cv_text_modal" class="form-control" rows="10" placeholder="Paste your full CV, resume, or a detailed list of your key skills and experience here...">{{ user_cv_text }}</textarea>
                                    </div>
                                    {# Keep preferences in its own modal, or decide if one modal is enough #}
                                    <input type="hidden" name="user_preferences_text" value="{{ user_preferences_text }}">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-cogs"></i> Extract Profile & Match Jobs</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            <!-- CV Modal -->
                <!-- Place this snippet above or below the existing modal code in main_page.html, depending on where you want the parsed results displayed. A good place would be immediately below the modal. -->
                <div class="modal fade" id="cvModal" tabindex="-1" aria-labelledby="cvModalLabel" aria-hidden="true">
                    ... (existing modal code) ...
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        ...
                        <input type="file" name="user_cv_file">
                        <button type="submit">Extract</button>
                    </form>
                </div>
                <!-- Display Parsed Data Block -->
                {% if parsed_data %}
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Extracted Information</h5>
                        </div>
                        <div class="card-body">
                            {% if parsed_data.name %}<p><strong>Name:</strong> {{ parsed_data.name }}</p>{% endif %}
                            {% if parsed_data.email %}<p><strong>Email:</strong> {{ parsed_data.email }}</p>{% endif %}
                            {% if parsed_data.contact_number %}<p><strong>Contact Number:</strong> {{ parsed_data.contact_number }}</p>{% endif %}
                            {% if parsed_data.skills %}<p><strong>Skills:</strong> {{ parsed_data.skills|join:", " }}</p>{% endif %}
                            {% if parsed_data.education %}<p><strong>Education:</strong> {{ parsed_data.education|join:", " }}</p>{% endif %}
                        </div>
                    </div>
                {% endif %}
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="user_cv_file_modal" class="form-label"><strong>Upload your CV (PDF):</strong></label>
                        <input type="file" name="user_cv_file" id="user_cv_file_modal" class="form-control" accept="application/pdf">
                    </div>
                    <div class="form-group mb-3">
                        <label for="user_cv_text_modal" class="form-label"><strong>OR Paste your CV / Resume:</strong></label>
                        <textarea name="user_cv_text" id="user_cv_text_modal" class="form-control" rows="10" placeholder="Paste your CV, resume, or a detailed list of your key skills and experience here...">{{ user_cv_text }}</textarea>
                    </div>
                    <input type="hidden" name="user_preferences_text" value="{{ user_preferences_text }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-cogs"></i> Extract Profile & Match Jobs</button>
                </div>

                <!-- Preferences Modal -->
                <div class="modal fade" id="preferencesModal" tabindex="-1" aria-labelledby="preferencesModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                             <form method="POST" action="{% url 'matcher:main_page' %}" id="preferencesForm">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="preferencesModalLabel">Edit Preferences</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                        <div class="form-group mb-3">
                                        <label for="user_preferences_text_modal" class="form-label"><strong>Your Preferences:</strong></label>
                                        <textarea name="user_preferences_text" id="user_preferences_text_modal" class="form-control" rows="6" placeholder="Describe your job preferences: desired roles, location (e.g., Berlin, Remote), work model (Remote, Hybrid), salary expectations (e.g., 60-70k EUR p.a.), company culture, etc.">{{ user_preferences_text }}</textarea>
                                    </div>
                                    <input type="hidden" name="user_cv_text" value="{{ user_cv_text }}">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-cogs"></i> Update Preferences & Match Jobs</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Original Skills Input Form (Now potentially redundant or for initial input if no session) -->
                {% if not current_match_session_id and not user_cv_text and not user_preferences_text %}
                <div class="card mt-4 mb-4 bg-light border-dashed">
                    <!-- <div class="card-body text-center p-5">
                        <i class="fas fa-file-alt fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">Get Started</h5>
                        <p class="text-muted">Upload your CV and set your preferences to find job matches.</p>
                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#cvModal">
                            <i class="fas fa-upload me-2"></i> Upload CV & Preferences
                        </button>
                </div> -->
            </div>
                {% endif %}


            <!-- Matched Job Listings -->
            {% if processed_job_matches %}
                <div class="mt-4">
                    <!-- <h4 class="mb-3">Matched Jobs</h4> -->
                <p class="text-muted">
                    {% if selected_session_object %}
                        Displaying results for match session from {{ selected_session_object.matched_at|date:"F d, Y, P" }}.
                    {% elif current_match_session_id %}
                            Displaying results from your latest submission.
                    {% endif %}
                </p>
                    <div class="row row-cols-1 g-4">
                    {% for match_item in processed_job_matches %}
                            <div class="col">
                                <div class="card jobbAI-job-card shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h5 class="card-title mb-0">
                                {% if current_match_session_id %}
                                                        <a href="{% url 'matcher:job_detail_page' match_item.job.id current_match_session_id %}" class="text-decoration-none">
                                                            {{ match_item.job.job_title }}
                                    </a>
                                {% else %}
                                                        <a href="{% url 'matcher:job_detail_page_no_session' match_item.job.id %}" class="text-decoration-none">
                                                            {{ match_item.job.job_title }}
                                    </a>
                                {% endif %}
                                {% if match_item.saved_status == 'applied' %}
                                            <span class="badge status-badge status-applied mb-2" id="job-status-badge-matched-{{ match_item.job.id }}">Status: Applied</span>
                                        {% elif match_item.saved_status == 'viewed' %}
                                            <span class="badge status-badge status-viewed mb-2" id="job-status-badge-matched-{{ match_item.job.id }}">Status: Viewed</span>
                                        {% else %} {# Default to not-applied or any other status not explicitly handled #}
                                            <span class="badge status-badge status-not-applied mb-2" id="job-status-badge-matched-{{ match_item.job.id }}">Status: {% if match_item.saved_status %}{{ match_item.saved_status|capfirst }}{% else %}Not Applied{% endif %}</span>
                                        {% endif %}
                                                </h5>
                                                <small class="text-muted">{{ match_item.job.company_name }}</small>
                                            </div>
                                            <div class="text-center">
                                                <!-- <span class="badge bg-primary rounded-pill fs-6">{{ match_item.score|floatformat:0 }}%</span> -->
                                                <h2 class="h2 mb-1">{{ match_item.score|floatformat:0 }}%</h2>
                                                <small class="d-block text-muted mt-0">Match Score</small>
                                            </div>
                                        </div>

                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-briefcase"></i> {{ match_item.job.level|default:"Unknown Level" }} |
                                                <i class="fas fa-map-marker-alt"></i> {{ match_item.job.location|default:"Unknown Location" }} |
                                                <i class="fas fa-industry"></i> {{ match_item.job.industry|default:"Unknown Industry" }} |
                                                <i class="fas fa-clock"></i> {{ match_item.job.flexibility|default:"Unknown flexibility"}} |
                                                <i class="fas fa-dollar-sign"></i> {{ match_item.job.salary_range|default:"Unknown salary range"}}
                                            </small>
                            </div>

                                        <p class="card-text small mb-2">
                                            {{ match_item.reason|truncatewords:20|linebreaksbr }}
                                        </p>



                                        <!-- Insights Table (Pros/Cons) -->
                                {% if match_item.parsed_insights_list %}
                                            <div class="accordion accordion-flush accordion-sm mb-2" id="accordionInsights{{ match_item.job.id }}">
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header" id="headingInsights{{ match_item.job.id }}">
                                                        <button class="accordion-button p-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInsights{{ match_item.job.id }}" aria-expanded="true" aria-controls="collapseInsights{{ match_item.job.id }}">
                                                            <small><strong><i class="fas fa-lightbulb me-1"></i> Key Insights</strong></small>
                                                        </button>
                                                    </h2>
                                                    <div id="collapseInsights{{ match_item.job.id }}" class="accordion-collapse collapse show" aria-labelledby="headingInsights{{ match_item.job.id }}">
                                                        <div class="accordion-body p-0">
                                                            <table class="table table-sm small table-borderless mb-0">
                                        <thead>
                                            <tr>
                                                                        <th scope="col" class="w-50 ps-2 text-success"><small>Pros</small></th>
                                                                        <th scope="col" class="w-50 ps-2 text-danger"><small>Cons</small></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for pro_insight, con_insight in match_item.parsed_insights_list %}
                                            <tr>
                                                                        <td class="ps-2 align-top"><small>{% if pro_insight %}<i class="fas fa-check-circle text-success me-1"></i>{{ pro_insight }}{% endif %}</small></td>
                                                                        <td class="ps-2 align-top"><small>{% if con_insight %}<i class="fas fa-times-circle text-danger me-1"></i>{{ con_insight }}{% endif %}</small></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                {% endif %}

                                {% if match_item.tips and match_item.tips != 'N/A' %}
                                            <div class="accordion accordion-flush accordion-sm mb-3" id="accordionTips{{ match_item.job.id }}">
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header" id="headingTips{{ match_item.job.id }}">
                                                        <button class="accordion-button p-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTips{{ match_item.job.id }}" aria-expanded="true" aria-controls="collapseTips{{ match_item.job.id }}">
                                                             <small><strong><i class="fas fa-bullseye me-1"></i> Application Tips</strong></small>
                                                        </button>
                                                    </h2>
                                                    <div id="collapseTips{{ match_item.job.id }}" class="accordion-collapse collapse show" aria-labelledby="headingTips{{ match_item.job.id }}">
                                                        <div class="accordion-body p-2">
                                                            <small>{{ match_item.tips|linebreaksbr }}</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                {% endif %}
                                    </div>
                                    <div class="card-footer bg-light border-top-0 p-2">
                                        <div class="d-flex justify-content-end">
                                            <a href="{% url 'matcher:job_detail_page' job_id=match_item.job.id match_session_id=current_match_session_id %}" 
                                            class="btn btn-outline-secondary btn-sm me-2">
                                                <i class="fas fa-info-circle me-1"></i> View Details
                                            </a>
                                    {% if match_item.job.application_url %}
                                    <a href="{{ match_item.job.application_url }}"
                                       class="btn btn-success btn-sm ms-2 apply-now-btn-trigger"
                                       target="_blank" rel="noopener noreferrer"
                                       data-job-id="{{ match_item.job.id }}"
                                       data-job-title="{{ match_item.job.job_title }}"
                                       data-list-type="matched">
                                                <i class="fas fa-external-link-alt me-1"></i> Apply Now
                                    </a>
                                    {% else %}
                                    <button type="button" 
                                    class="btn btn-success btn-sm ms-2" 
                                    disabled title="No application link available">
                                                <i class="fas fa-external-link-alt me-1"></i> Apply Now
                                    </button>
                                    {% endif %}
                                        </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
            </div>
            {% elif request.method == 'POST' and not processed_job_matches %}
                 <div class="mt-5 text-center">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4>No Specific Matches Found</h4>
                    <p class="text-muted">
                        We couldn't find specific matches for your current CV and preferences.
                        Try updating them or browse all available jobs.
                    </p>
                     <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#cvModal">
                        <i class="fas fa-edit me-1"></i> Update CV/Preferences
                    </button>
                    {# Optional: Add button to show all jobs if not already visible #}
            </div>
            {% elif current_match_session_id and not processed_job_matches %}
                 <div class="mt-5 text-center">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h4>No Matches in This Session</h4>
                    <p class="text-muted">
                        The selected historical session does not contain any matched jobs.
                    </p>
                     <a href="{% url 'matcher:main_page' %}" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-1"></i> Start a New Match
                    </a>
            </div>
            {% endif %}

                <!-- All Available Job Listings (Kept for now, styling can be refined based on Figma) -->
            <div class="mt-5 mb-5">
                    <h4 class="mb-3">All Available Jobs <span class="badge bg-light text-dark ms-2">{{ all_jobs_count }}</span></h4>
                {% if all_jobs_annotated %}
                        <div class="row row-cols-1 g-4">
                        {% for item in all_jobs_annotated %}
                        <div class="col">
                                <div class="card jobbAI-job-card-all shadow-sm">
                                <div class="card-body">
                                        <h5 class="card-title">
                                            <a href="{% url 'matcher:job_detail_page_no_session' item.job_object.id %}" class="text-decoration-none">
                                                {{ item.job_object.job_title }}
                                            </a>
                                        </h5>
                                    <h6 class="card-subtitle mb-2 text-muted">{{ item.job_object.company_name }}</h6>

                                        <div class="mb-2">
                                            <small class="text-muted">
                                            {% if item.job_object.level %}{{ item.job_object.level }} | {% endif %}
                                            {% if item.job_object.location %}{{ item.job_object.location }} | {% endif %}
                                            {% if item.job_object.industry %}{{ item.job_object.industry }}{% endif %}
                                            </small>
                                        </div>

                                    {% if item.saved_status %}
                                            <p class="mb-1 small" id="job-status-paragraph-all-{{ item.job_object.id }}"><small><strong>Status:</strong>
                                                <span class="badge status-badge {% if item.saved_status == 'applied' %}status-applied{% elif item.saved_status == 'viewed' %}status-viewed{% else %}status-not-applied{% endif %}" id="job-status-badge-all-{{ item.job_object.id }}">
                                                    {% if item.saved_status %}{{ item.saved_status|capfirst }}{% else %}Not Applied{% endif %}
                                                </span></small>
                                            </p>
                                    {% else %}
                                            <p class="mb-1 small" id="job-status-paragraph-all-{{ item.job_object.id }}" style="display: none;"><small><strong>Status:</strong>
                                                <span class="badge status-badge status-not-applied" id="job-status-badge-all-{{ item.job_object.id }}">Not Applied</span></small>
                                            </p>
                                    {% endif %}
                                        <p class="card-text small"><small>{{ item.job_object.description|truncatewords:20 }}</small></p>
                                </div>
                                    <div class="card-footer bg-light border-top-0 p-2">
                                        <div class="d-flex justify-content-end">
                                            <a href="{% url 'matcher:job_detail_page_no_session' item.job_object.id %}" class="btn btn-outline-secondary btn-sm me-2"><i class="fas fa-info-circle me-1"></i> Details</a>
                                     {% if item.job_object.application_url %}
                                     <a href="{{ item.job_object.application_url }}"
                                        class="btn btn-success btn-sm apply-now-btn-trigger"
                                        target="_blank" rel="noopener noreferrer"
                                        data-job-id="{{ item.job_object.id }}"
                                        data-job-title="{{ item.job_object.job_title }}"
                                        data-list-type="all">
                                                 <i class="fas fa-external-link-alt me-1"></i> Apply
                                     </a>
                                     {% else %}
                                     <button type="button" class="btn btn-success btn-sm" disabled title="No application link available">
                                                 <i class="fas fa-external-link-alt me-1"></i> Apply
                                     </button>
                                     {% endif %}
                                        </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                        <p class="text-center text-muted mt-4">No other job listings available at the moment.</p>
                {% endif %}
            </div>
        </main>
        </div>
    </div>
</div>

<!-- Apply Confirmation Modal (Keep as is) -->
<div class="modal fade" id="applyConfirmationModal" tabindex="-1" aria-labelledby="applyConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="applyConfirmationModalLabel">Confirm Application</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        The application page for <strong id="modalJobTitle">this job</strong> has opened in a new tab.
        <br><br>Have you submitted your application?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Not Yet / Cancel</button>
        <button type="button" class="btn btn-success" id="confirmAppliedButton">Yes, I Applied</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebarMenu');
    const mainContent = document.querySelector('.jobbAI-main-content');
    // For mobile, the navbar-toggler in jobbAI-top-nav will handle the #sidebarMenu
    // For desktop, we need a new toggle if the design implies one, or it's always open.
    // The Figma design shows sidebar always present on larger screens, and main content next to it.
    // Let's assume no explicit desktop toggle button for now, sidebar is either there or not based on screen.

    // The Bootstrap collapse for mobile sidebar is tied to the navbar-toggler with data-bs-target="#sidebarMenu"
    // We need to ensure the main content adjusts if the mobile sidebar becomes visible (overlays)
    // or if we want a push behavior. Figma implies overlay for mobile if sidebar is triggered.

    // Handle CV and Preferences form submissions within modals to keep page state
    // This is a simplified example; you might want to use AJAX for a smoother experience
    // or ensure the page reloads correctly showing the modal again if there are errors.

    const cvForm = document.getElementById('cvForm');
    if (cvForm) {
        // If you want to submit via AJAX to avoid full page reload:
        // cvForm.addEventListener('submit', function(event) {
        //     event.preventDefault();
        //     // AJAX submission logic here
        //     // On success, potentially close modal and refresh parts of the page
        // });
    }
    const preferencesForm = document.getElementById('preferencesForm');
    if (preferencesForm) {
        // preferencesForm.addEventListener('submit', function(event) {
        //     event.preventDefault();
        //     // AJAX submission logic here
        // });
        }


    // Apply Confirmation Modal Logic (Keep as is, assuming it works with new structure)
    const applyConfirmationModalEl = document.getElementById('applyConfirmationModal');
    const modalJobTitleEl = document.getElementById('modalJobTitle');
    const confirmAppliedButton = document.getElementById('confirmAppliedButton');
    const applyNowButtons = document.querySelectorAll('.apply-now-btn-trigger');
    let modalInstance = null;
    if (applyConfirmationModalEl) {
        modalInstance = new bootstrap.Modal(applyConfirmationModalEl);
    }

    applyNowButtons.forEach(button => {
        button.addEventListener('click', function (event) {
            event.preventDefault();
            const jobTitle = this.getAttribute('data-job-title');
            const jobId = this.getAttribute('data-job-id');
            const listType = this.getAttribute('data-list-type');
            const applicationUrl = this.href;

            window.open(applicationUrl, '_blank');

            sessionStorage.setItem('pendingApplicationJobId', jobId);
            sessionStorage.setItem('pendingApplicationJobTitle', jobTitle);
            sessionStorage.setItem('pendingApplicationListType', listType);
        });
    });

    window.addEventListener('focus', function() {
        const pendingJobId = sessionStorage.getItem('pendingApplicationJobId');
        if (pendingJobId && modalInstance) {
            const pendingJobTitle = sessionStorage.getItem('pendingApplicationJobTitle');
            const pendingListType = sessionStorage.getItem('pendingApplicationListType');

            if (modalJobTitleEl) {
                modalJobTitleEl.textContent = pendingJobTitle || 'this job';
            }
            if (confirmAppliedButton) {
                confirmAppliedButton.dataset.jobId = pendingJobId;
                confirmAppliedButton.dataset.listType = pendingListType;
            }
            modalInstance.show();
        }
    });

    function clearPendingApplicationState() {
        sessionStorage.removeItem('pendingApplicationJobId');
        sessionStorage.removeItem('pendingApplicationJobTitle');
        sessionStorage.removeItem('pendingApplicationListType');
        if (confirmAppliedButton) {
            delete confirmAppliedButton.dataset.jobId;
            delete confirmAppliedButton.dataset.listType;
        }
    }

    if (confirmAppliedButton) {
        confirmAppliedButton.addEventListener('click', function () {
            const jobId = this.dataset.jobId;
            const listType = this.dataset.listType;

            if (jobId && listType) {
                fetch(`/job/${jobId}/update_status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ status: 'applied' })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Server error response text:', text.substring(0, 500));
                            try {
                                const errData = JSON.parse(text);
                                throw new Error(errData.message || `HTTP error ${response.status}`);
                            } catch (e) {
                                throw new Error(`HTTP error ${response.status}. Response not valid JSON.`);
                            }
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log('Status updated successfully for job', jobId, 'to', data.new_status);

                        let statusBadge = null;
                        let statusParagraph = null;

                        if (listType === 'matched') {
                            statusBadge = document.getElementById(`job-status-badge-matched-${jobId}`);
                        } else if (listType === 'all') {
                            statusBadge = document.getElementById(`job-status-badge-all-${jobId}`);
                            statusParagraph = document.getElementById(`job-status-paragraph-all-${jobId}`);
                        }

                        if (statusBadge) {
                            // Update text content
                            statusBadge.textContent = `Status: ${data.new_status_display || data.new_status}`;

                            // Define a list of all possible status classes we use
                            const allStatusClasses = ['status-applied', 'status-not-applied', 'status-viewed']; // Add any other status slugs here

                            // Remove any existing status class
                            allStatusClasses.forEach(cls => statusBadge.classList.remove(cls));

                            // Add the new status class based on data.new_status
                            // Assuming data.new_status is a slug like 'applied', 'not_applied', 'viewed'
                            let newStatusClass = `status-${data.new_status.toLowerCase().replace('_', '-')}`;
                            if (allStatusClasses.includes(newStatusClass)) {
                                statusBadge.classList.add(newStatusClass);
                            } else {
                                statusBadge.classList.add('status-not-applied'); // Fallback to not-applied
                                console.warn(`Unknown status slug: ${data.new_status}, falling back to status-not-applied`);
                            }

                            if (statusParagraph) {
                                statusParagraph.style.display = '';
                            }
                        } else {
                            console.warn('Could not find status badge for job', jobId, 'listType', listType);
                        }

                    } else {
                        console.error('Failed to update status (server-side):', data.message);
                        alert('Error updating status: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Fetch API Error:', error);
                    alert('An error occurred: ' + error.message);
                })
                .finally(() => {
                    if (modalInstance) modalInstance.hide();
                    clearPendingApplicationState();
                });
            }
        });
    }

    if (applyConfirmationModalEl) {
        applyConfirmationModalEl.addEventListener('hidden.bs.modal', function () {
            clearPendingApplicationState();
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add a class to body to indicate new layout is active, for specific global overrides if needed
    document.body.classList.add('jobbAI-layout-active');

    // Logic for mobile sidebar toggle if needed, beyond Bootstrap's default
    // Example: When mobile sidebar (#sidebarMenu) is shown/hidden by Bootstrap,
    // we might want to change an icon in the main top navbar toggler.
    const mobileSidebarToggler = document.querySelector('.navbar-toggler[data-bs-target="#sidebarMenu"]');
    if (sidebar && mobileSidebarToggler) {
        const bsCollapse = new bootstrap.Collapse(sidebar, { toggle: false });
        // Listen to Bootstrap's events
        sidebar.addEventListener('shown.bs.collapse', function () {
            // Mobile sidebar is now open
            // mobileSidebarToggler.innerHTML = '<i class="fas fa-times"></i>'; // Change to close icon
            // CSS handles the main content push now via sibling selector
        });
        sidebar.addEventListener('hidden.bs.collapse', function () {
            // Mobile sidebar is now closed
            // mobileSidebarToggler.innerHTML = '<i class="fas fa-bars"></i>'; // Change back to hamburger
            // CSS handles the main content margin reset now
        });
    }
    document.addEventListener('DOMContentLoaded', function () {
    {% if parsed_data %}
      var modal = new bootstrap.Modal(document.getElementById('cvModal'));
      modal.show();
    {% endif %}
  });

});
</script>

{% endblock %}